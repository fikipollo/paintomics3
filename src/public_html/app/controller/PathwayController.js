function PathwayController(){this.downloadPathwayHandler=function(pathwayView,jobID,format){showInfoMessage("Generating image, please wait...",{logMessage:"Sending SVG image to server",showSpin:true,itemId:jobID,icon:"clock"});var image=new Image;var src=$("#"+pathwayView.getComponent().id+" image")[0].href.baseVal;image.src=src;$(image).load(function(){var canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;var context=canvas.getContext("2d");context.drawImage(image,0,0);var forcedImageCode=canvas.toDataURL();if(forcedImageCode=="data:,"){showErrorMessage("Unable to download image, please try again.");return}var svgElem=$("#"+pathwayView.getComponent().id+" svg.keggPathwaySVG").clone();var original_width=image.width*3;var original_height=image.height*3;var current_height=Number.parseFloat(svgElem.find(".keggImageBack").attr("height"));var current_width=Number.parseFloat(svgElem.find(".keggImageBack").attr("width"));canvas=SVG(svgElem[0]);canvas.viewbox(0,0,current_width,current_height);canvas.text("Created with PaintOmics 3").size(8).attr({x:current_width-100,y:current_height-15});canvas.height(original_height);canvas.width(original_width);var svgString=(new XMLSerializer).serializeToString(svgElem[0]);svgString=svgString.replace(src,forcedImageCode);var fileName=pathwayView.getModel().getName();$.ajax({type:"POST",headers:{"Content-Encoding":"gzip"},url:SERVER_URL_PA_SAVE_IMAGE,data:{fileName:fileName.replace(" ","_"),jobID:jobID,format:format,svgCode:svgString},success:function(response){showSuccessMessage("Done",{logMessage:"Image generated successfully",closeTimeout:.5});var a=document.createElement("a");a.download="paintomics_"+fileName.replace(" ","_")+"_"+jobID+"."+format;a.type="image/"+format;a.href=response.filepath;a.target="_blank";a.style="display:none";a.id="downloadImage";$("body").append(a);a.click();$("body").remove("#downloadImage")},error:ajaxErrorHandler})})}}